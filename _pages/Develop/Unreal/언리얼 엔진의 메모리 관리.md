---
title: "[Unreal] 언리얼 엔진의 메모리 관리"
date: "2024-6-27"
thumbnail: "/assets/img/unreal.jpg"
---

# [Unreal] 언리얼 엔진의 메모리 관리

## 언리얼 엔진의 자동 메모리 관리

- c++ 언어 메모리 관리의 문제점
  - 저수준으로 메모리 주소에 직접 접근하는 포인터를 사용
  - 직접 할당과 해지의 짝맞추기를 해줘야함.
    - 메모리 누수(Leak) : 할당 했는데 해지 안한 경우
    - 허상(Dangling) 포인터 : 사용 중인 포인터를 다른 곳에서 해제해버림. 그걸 사용 한 경우
    - 와일드(Whild) 포인터 : 값이 초기화되지 않아 엉뚱한 주소를 가르키는 경우
  - JAVA/C#은 이런 포인터 시스템을 버리고 가비지 컬렉션 시스템을 채택함
- 가비지 컬렉션 시스템
  - 프로그램에서 더 이상 사용하지 않는 오브젝트를 자동으로 감지해 메모리를 회수
  - 동적으로 생성된 모든 오브젝트 정보를 모아둔 저장소를 사용해 사용되지 않는 메모리 추적
  - 마크-스윕(Mark-Sweep) 방식의 가비지 컬렉션
    - 저장소에서 최초 검색을 시작하는 루트 오브젝트를 표기.
    - 루트 오브젝트가 참조되는 객체를 찾아 마크(Mark).
    - 마크 된 객체로부터 다시 참조되는 객체를 찾아 또 마크.
    - 저장소에 마크, 미마크 두 그룹으로 나뉨.
    - 가비지 컬렉터가 저장소에서 마크되지 않은 객체들의 메모리를 회수(sweep)
- 언리얼 엔진의 가비지 컬렉션 시스템
  - 마크-스윕 방식의 가비지컬렉션 시스템을 자체적으로 구축
  - 지정된 주기마다 몰아서 없애도록 설정(GCCycle) - 기본 60초
  - 부하가 적지않아서 다양한 옵션을 탑재
  - **가비지 컬렉션을 위한 객체 저장소**
    - 관리되는 모든 언리얼 오브젝트의 정보를 저장하는 전역 변수 : GUObjectArray
      - 각 요소에 플래그가 설정되어있음
        - Garbage 플래그 : 다른 언리얼 오브젝트로부터 참조가 없어진 오브젝트
        - RootSet 플래그 : 최초의 참초 시작 오브젝트(회수하지 않음)
        - 수동이 아니라 자동으로 설정되는 시스템임.
          - 한번 생성된 오브젝트를 삭제하기 위해서 메모리에서 직접 삭제를하는 것이 아니라 엔진 종속적으로 삭제해줘야함
  - **가비지 컬렉션 시스템을 통한 포인터 문제 해결**
    - 메모리 누수 문제
      - 언리얼 오브젝트는 가비지 컬렉터를 통해 자동으로 해결
      - C++ 오브젝트는 직접 신경써야 함.
    - 댕글링 포인터 문제
      - 이를 탐지하기 위한 함수 제공::IsValid()
      - C++ 오브젝트는 직접 신경
    - 와일드 포인터 문제
      - UPROPERY() 속성을 지정하면 자동으로 nullptr로 초기화 해줌
      - C++ 오브젝트는 마찬가지로 직접 해야함.
  - **언리얼 오브젝트 관리원칙**
    - 생성된 언리얼 오브젝트를 유지하기 위해 레퍼런스 참조 방법을 설계할 것.
      - 언리얼 오브젝트 내의 언리얼 오브젝트 : UPROPERTY 사용
      - 일반 C++ 오브젝트 내의 언리얼 오브젝트 : FGCObject 상속 후 구현
    - 생성된 언리얼 오브젝트는 강제로 지우려고 하지 말 것.
      - 참조를 끊는다는 생각으로 설계할 것
      - 가비지 컬렉터에게 회수를 재촉할 수 있음(ForceGarbageCollection 함수)
      - 콘텐츠 제작에서 Destroy함수를 사용할 수 있으나, 결국 내부 동작은 동일함.